<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>NATO Chat</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#202123;color:#ddd;display:flex;height:100vh;}
#sidebar{width:250px;background:#343541;display:flex;flex-direction:column;}
#sidebar h3{margin:10px 0 5px 0;text-align:center;}
#userSearch{margin:0 10px 10px 10px;padding:6px;border:none;border-radius:5px;background:#202123;color:#fff;}
#users{flex:1;overflow-y:auto;padding:10px;}
#users div{padding:5px;cursor:pointer;}
#users div:hover{background:#4b4b5e;}
#chat-container{flex:1;display:flex;flex-direction:column;}
#chat{flex:1;overflow-y:auto;padding:10px;background:#444654;}
.message{margin:5px 0;}
.system{opacity:0.6;font-style:italic;}
.adminMsg{color:red;font-weight:bold;}
.private{color:red;}
#input-container{display:flex;}
#msg{flex:1;padding:10px;border:none;background:#343541;color:#fff;}
button{background:#444654;color:#fff;border:none;padding:8px;cursor:pointer;}
#adminBtn{position:fixed;bottom:10px;left:10px;background:#4a4a5e;}
#loginScreen{position:absolute;top:0;left:0;width:100%;height:100%;background:#202123;display:flex;justify-content:center;align-items:center;flex-direction:column;}
input.loginInput{margin:5px;padding:8px;width:200px;}
#loginBtn{margin-top:10px;padding:8px 16px;}
#userOverlay{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#343541;padding:20px;border-radius:10px;color:#fff;z-index:1000;}
#userOverlay button{margin-top:5px;}
</style>
</head>
<body>

<div id="loginScreen">
  <h2>Login</h2>
  <input id="loginCallsign" class="loginInput" placeholder="CALLSIGN (NATO only)">
  <input id="loginName" class="loginInput" placeholder="NAME (NATO only)">
  <button id="loginBtn">Login</button>
</div>

<div id="sidebar">
  <h3>Online Users</h3>
  <input id="userSearch" placeholder="Search users...">
  <div id="users"></div>
</div>

<div id="chat-container">
  <div id="chat"></div>
  <div id="input-container">
    <input id="msg" placeholder="TYPE MESSAGE AND PRESS ENTER">
  </div>
</div>

<button id="adminBtn">Admin Login</button>

<div id="userOverlay">
  <div id="overlayName"></div>
  <div id="overlayIP"></div>
  <div id="overlayConnected"></div>
  <button id="toBtn">TO</button>
  <button id="adminDMBtn" style="display:none;">ADMIN DM</button>
  <button id="adminBroadcastBtn" style="display:none;">ADMIN MESSAGE</button>
  <button id="adminLogoutBtn" style="display:none;">Log Out User</button>
  <button id="adminMuteBtn" style="display:none;">Mute User</button>
  <button id="adminUnmuteBtn" style="display:none;">Unmute User</button>
  <button id="closeOverlay">Close</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket=io();
const chat=document.getElementById("chat");
const usersDiv=document.getElementById("users");
const userSearch=document.getElementById("userSearch");
const msgInput=document.getElementById("msg");
const adminBtn=document.getElementById("adminBtn");

let currentUser=null,allUsers=[],selectedUser=null,currentTO=null,muted=false;

/* CHAT */
function addMessage(t,c=""){const d=document.createElement("div");d.className="message "+c;d.textContent=t;chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}

/* USERS */
function renderUsers(){
 usersDiv.innerHTML="";
 allUsers.filter(u=>u.callsign.toLowerCase().includes(userSearch.value.toLowerCase()))
 .forEach(u=>{
  const d=document.createElement("div");
  d.textContent=u.callsign;
  d.style.color=u.admin?"red":u.socketId===socket.id?"yellow":"#fff";
  d.onclick=()=>showOverlay(u);
  usersDiv.appendChild(d);
 });
}
userSearch.oninput=renderUsers;

/* LOGIN */
loginBtn.onclick=()=>{
 const c=loginCallsign.value.trim().toUpperCase();
 const n=loginName.value.trim().toUpperCase();
 socket.emit("register",{callsign:c,name:n},r=>{
  if(!r.ok)return alert(r.err);
  loginScreen.style.display="none";
  currentUser={callsign:c,name:n,admin:false};
 });
};

/* ADMIN LOGIN */
adminBtn.onclick=()=>{
 if(currentUser.admin){
  socket.emit("leaveAdmin");
 }else{
  const pw=prompt("ADMIN PASSWORD");
  if(!pw)return;
  socket.emit("becomeAdmin",{password:pw},r=>{
   if(!r.ok)return alert(r.err);
   currentUser.admin=true;
   adminBtn.textContent="Leave Admin";
  });
 }
};

/* MESSAGE SEND */
msgInput.onkeydown=e=>{
 if(e.key==="Enter"&&msgInput.value.trim()){
  if(muted)return alert("Muted");
  socket.emit("chat",{text:msgInput.value,to:currentTO?.callsign});
  msgInput.value="";
  currentTO=null;
 }
};

/* OVERLAY */
function showOverlay(u){
 selectedUser=u;
 overlayName.textContent=`${u.callsign} (${u.name})`;
 overlayIP.textContent=`IP: ${u.ip}`;
 overlayConnected.textContent=`Connected: ${new Date(u.connectedAt).toLocaleString()}`;
 const adminView=currentUser?.admin && !u.admin;
 adminDMBtn.style.display=adminView?"block":"none";
 adminBroadcastBtn.style.display=currentUser?.admin?"block":"none";
 adminLogoutBtn.style.display=adminView?"block":"none";
 adminMuteBtn.style.display=adminView?"block":"none";
 adminUnmuteBtn.style.display=adminView?"block":"none";
 userOverlay.style.display="block";
}
closeOverlay.onclick=()=>userOverlay.style.display="none";
toBtn.onclick=()=>{currentTO=selectedUser;alert(`NEXT MESSAGE TO ${selectedUser.callsign}`);};

/* ADMIN ACTIONS */
adminDMBtn.onclick=()=>{
 const msg=prompt(`ADMIN DM TO ${selectedUser.callsign}`);
 if(msg)socket.emit("adminDM",{to:selectedUser.callsign,text:msg});
};
adminBroadcastBtn.onclick=()=>{
 const msg=prompt("ADMIN MESSAGE TO CHAT");
 if(msg)socket.emit("adminBroadcast",{text:msg});
};
adminLogoutBtn.onclick=()=>socket.emit("adminLogoutUser",{callsign:selectedUser.callsign});
adminMuteBtn.onclick=()=>socket.emit("adminMuteUser",{callsign:selectedUser.callsign,minutes:5});
adminUnmuteBtn.onclick=()=>socket.emit("adminUnmuteUser",{callsign:selectedUser.callsign});

/* SOCKET */
socket.on("chat",d=>addMessage(d.text));
socket.on("adminMessage",d=>addMessage(`ADMIN: ${d.text}`,"adminMsg"));
socket.on("adminDM",d=>addMessage(`ADMIN â†’ YOU: ${d.text}`,"private"));
socket.on("system",d=>addMessage(d.text,"system"));
socket.on("userUpdate",u=>{allUsers=u;renderUsers();});
socket.on("muted",()=>muted=true);
socket.on("unmuted",()=>muted=false);
socket.on("forceLogout",()=>location.reload());
</script>
</body>
</html>
